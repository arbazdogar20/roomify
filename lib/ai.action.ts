import puter from "@heyputer/puter.js";
import { ROOMIFY_RENDER_PROMPT } from "./constants";

export async function fetchAsDataUrl(url: string): Promise<string> {
  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(
      `Failed to fetch image: ${response.status} ${response.statusText}`,
    );
  }

  const blob = await response.blob();

  return new Promise<string>((resolve, reject) => {
    const reader = new FileReader();

    reader.onloadend = () => {
      if (typeof reader.result === "string") {
        resolve(reader.result);
        return;
      }

      reject(new Error("Failed to convert blob to Data URL"));
    };

    reader.onerror = () => {
      reject(reader.error ?? new Error("FileReader failed while reading blob"));
    };

    reader.readAsDataURL(blob);
  });
}

export const generate3Dview = async ({ sourceImage }: Generate3DViewParams) => {
  const dataUrl = sourceImage.startsWith("data:")
    ? sourceImage
    : await fetchAsDataUrl(sourceImage);

  const base64Data = dataUrl.split(",")[1];
  const mimeType = dataUrl.split(";")[0].split(":")[1];

  if (!base64Data || !mimeType) throw new Error("Invalid Source Image Payload");

  const response = await puter.ai.txt2img(ROOMIFY_RENDER_PROMPT, {
    provider: "gemini",
    model: "gemini-2.5-flash-image-preview",
    input_image: base64Data,
    input_image_mime_type: mimeType,
    ratio: { h: 1024, w: 1024 },
  });

  const rawImageUrl = (response as HTMLImageElement).src || null;
  if (!rawImageUrl)
    return {
      renderedImage: null,
      renderedPath: undefined,
    };

  const renderedImage = rawImageUrl.startsWith("data")
    ? rawImageUrl
    : await fetchAsDataUrl(rawImageUrl);

  return {
    renderedImage,
    renderedPath: undefined,
  };
};
